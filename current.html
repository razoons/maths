<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Jeux de Maths</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.5.4/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.5.4/dist/vuetify.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="app">
        <v-app>
            <!-- Barre de score -->
            <v-app-bar color="pink-darken-1 accent-4 " :height="160" class="border-lg rounded-xl" dark flat>
                <v-container class="d-flex flex-column align-center justify-center w-100">
                    <!-- Score -->
                    <div class="text-h1 font-kid text-center">
                        Score : {{ score }}
                    </div>

                    <!-- Progress bar under the score -->
                    <v-progress-linear v-model="progress" color="yellow-lighten-1" :height="30" class="w-100 mt-4" />
                </v-container>

            </v-app-bar>
            <v-main class="pa-4 d-flex ga-16 flex-column align-stretch justify-center" style="background-color:#0aaee3">
                <!-- Question -->
                <v-container>
                    <v-sheet size="x-large" color="white"
                        class="pa-16 font-kid text-h1 text-center elevation-24 border-lg rounded-xl">
                        {{ problem }}
                    </v-sheet>
                </v-container>

                <!-- Réponses -->
                <v-container>
                    <v-row>
                        <v-col cols="12" md="6" v-for="(resp, index) in responses" :key="index">
                            <v-btn @click="answer(resp)" size="x-large" rounded="pill" color="#f78d17"
                                class="h-auto border-lg d-flex text-h1 elevation-24 ma-auto w-100 font-kid"
                                :style="selected === resp ? (selected === correctAnswer ? 'background-color: #4caf50;' : 'background-color: #f44336;') : ''">
                                {{ resp }}
                            </v-btn>
                        </v-col>
                    </v-row>
                </v-container>
            </v-main>
            <v-dialog v-model="showDialog" persistent>
                <v-card class="rounded-xl pa-8" color="pink-darken-1 accent-4">
                    <v-card-text class="text-center text-h2 font-kid">
                        <span class="text-center text-h1 font-kid">Bravo!</span>
                        <br />
                        Ton score: <strong>{{ score }}</strong> / {{ nbrQuestions }}
                    </v-card-text>

                    <v-card-actions class="d-flex flex-column ga-16 justify-center">
                        <v-btn size="x-large" rounded="pill"
                            class="h-auto border-lg d-flex text-h1 elevation-24 ma-auto w-90 font-kid"
                            @click="restartGame" style="background-color: #f78d17;">
                            Recommencer
                        </v-btn>
                        <v-btn size="x-large" rounded="pill"
                            class="h-auto border-lg d-flex text-h1 elevation-24 ma-auto w-90 font-kid"
                            @click="backToMenu" style="background-color: #f78d17;">
                            Revenir au menu
                        </v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>
        </v-app>
    </div>
    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        const { createVuetify } = Vuetify;
        const params = new URLSearchParams(window.location.search);
        const difficulty = params.get("difficulty");
        const operation = params.get("operation");
        const nbrQuestions = 2;


        const app = createApp({
            setup() {
                const currentQuestion = ref(0);
                const problem = ref('');
                const correctAnswer = ref(0);
                const responses = ref(['0', '0', '0', '0']);
                const selected = ref(null);
                const score = ref(0);
                const progress = computed(() => (currentQuestion.value / nbrQuestions * 100)); // percent (0 - 100)
                const showDialog = ref(false);
                let correctAnswerTemp = 0;

                function generateProblem() {
                    currentQuestion.value++;
                    if (operation == 'addition') {
                        if (difficulty == 'facile') {
                            // Easy addition: numbers between 1 and 9
                            num1 = Math.floor(Math.random() * 9) + 1;
                            num2 = Math.floor(Math.random() * 9) + 1;

                        } else if (difficulty == 'moyen') {
                            // Medium addition: numbers between 10 and 99
                            num1 = Math.floor(Math.random() * 90) + 10;
                            num2 = Math.floor(Math.random() * 9) + 1;

                        } else if (difficulty == 'difficile') {
                            // Hard addition: numbers between 100 and 999
                            num1 = Math.floor(Math.random() * 90) + 10;
                            num2 = Math.floor(Math.random() * 90) + 10;

                        }
                        problem.value = `${num1} + ${num2}`;
                        correctAnswerTemp = num1 + num2;


                    } else if (operation == 'soustraction') {
                        if (difficulty == 'facile') {
                            // Easy subtraction: numbers between 1 and 9
                            num1 = Math.floor(Math.random() * 9) + 1;
                            num2 = Math.floor(Math.random() * num1) + 1; // ensure num2 is less than or equal to num1

                        } else if (difficulty == 'moyen') {
                            // Medium subtraction: numbers between 10 and 99
                            num1 = Math.floor(Math.random() * 90) + 10;
                            num2 = Math.min((Math.floor(Math.random() * 9) + 1), num1);

                        } else if (difficulty == 'difficile') {
                            // Hard subtraction: numbers between 100 and 999
                            num1 = Math.floor(Math.random() * 90) + 10;
                            num2 = Math.floor(Math.random() * num1) + 1;
                        }
                        problem.value = `${num1} - ${num2}`;
                        correctAnswerTemp = num1 - num2;


                    } else if (operation == 'probleme') {

                        const prenoms = [{ "prenom": "Marie", "genre": "f" }, { "prenom": "Antoine", "genre": "m" }, { "prenom": "Luc", "genre": "m" }, { "prenom": "Sophie", "genre": "f" }, { "prenom": "Julien", "genre": "m" }, { "prenom": "Clara", "genre": "f" }, { "prenom": "Maxime", "genre": "m" }, { "prenom": "Emma", "genre": "f" }, { "prenom": "Leo", "genre": "m" }, { "prenom": "Chloé", "genre": "f" }, { "prenom": "Thomas", "genre": "m" }, { "prenom": "Camille", "genre": "f" }, { "prenom": "Mathis", "genre": "m" }, { "prenom": "Lena", "genre": "f" }, { "prenom": "Gabriel", "genre": "m" }, { "prenom": "Manon", "genre": "f" }, { "prenom": "Arthur", "genre": "m" }, { "prenom": "Julie", "genre": "f" }];
                        const objets = ["pommes", "poires", "poireaux", "stylos", "cahiers", "ballons", "voitures", "poupées", "livres", "crayons", "gâteaux", "bonbons", "chocolats", "billes", "cartables", "ordinateurs", "tablettes", "téléphones", "vélos"];

                        const { prenom, genre } = prenoms[Math.floor(Math.random() * prenoms.length)];
                        const objet = objets[Math.floor(Math.random() * objets.length)];

                        const a = Math.floor(Math.random() * 5) + 5;
                        const b = Math.floor(Math.random() * 10) + 1;
                        const c = Math.floor(Math.random() * a) + 1;

                        // Genre
                        const sujet = genre === "m" ? "Il" : "Elle";
                        const pronom = genre === "m" ? "il" : "elle";


                        // Modèles de phrases
                        const templates = [
                            { "phrase": `${prenom} a ${a} ${objet}. ${sujet} en achète ${b} de plus. Combien de ${objet} a-t-${pronom} maintenant ?`, "resultat": a + b },
                            { "phrase": `${prenom} a ${a} ${objet}. ${sujet} en donne ${c} à son ami. Combien de ${objet} lui reste-t-${pronom} ?`, "resultat": a - c },
                            { "phrase": `${prenom} a ${a} ${objet}. ${sujet} en voudrait ${a + b}. Combien doit-${pronom} en acheter ?`, "resultat": b },
                            { "phrase": `${prenom} a ${a} ${objet}. Son ami en a ${a + b}. Combien son ami en a-t-il de plus ?`, "resultat": b },
                        ];

                        const probleme_instance = templates[Math.floor(Math.random() * templates.length)];
                        problem.value = probleme_instance.phrase;
                        correctAnswerTemp = probleme_instance.resultat;
                    }

                    correctAnswer.value = correctAnswerTemp;
                    const incorrectAnswers = new Set();

                    while (incorrectAnswers.size < 3) {
                        const offset = Math.floor(Math.random() * 3) + 1;
                        const sign = Math.random() < 0.5 ? -1 : 1;
                        const wrong = correctAnswerTemp + sign * offset;
                        if (wrong !== correctAnswerTemp && wrong > 0) {
                            incorrectAnswers.add(wrong);
                        }
                    }

                    const allAnswers = [correctAnswerTemp, ...incorrectAnswers];
                    responses.value = allAnswers.sort(() => Math.random() - 0.5);

                }

                function answer(selectedAnswer) {
                    selected.value = selectedAnswer;


                    setTimeout(() => {
                        if (selectedAnswer === correctAnswer.value) {
                            score.value += 1;
                        }
                        selected.value = null;
                        if (currentQuestion.value >= nbrQuestions) {
                            showDialog.value = true;

                            giveRewards(score.value);

                        } else {
                            // Generate next problem
                            generateProblem();
                        }
                    }, 2000); // short delay to show color change
                }

                function restartGame() {
                    score.value = 0;
                    currentQuestion.value = 0;
                    showDialog.value = false;
                    generateProblem();
                }

                function backToMenu() {
                    window.location.href = './index.html';
                }

                function giveRewards(score) {
                    if (score == 2) {
                        rewardsWon = 2;
                    } else if (score >= 1) {
                        rewardsWon = 1;
                    } else {
                        rewardsWon = 0;
                    }

                    const rewards = JSON.parse(localStorage.getItem("rewards")) || { stars: 0, fairies: 0, unicorns: 0 }
                    rewards.stars += rewardsWon;

                    rewards.fairies += Math.floor(rewards.stars / 10);
                    rewards.stars = rewards.stars % 10;

                    rewards.unicorns += Math.floor(rewards.fairies / 10);
                    rewards.fairies = rewards.fairies % 10;

                    localStorage.setItem("rewards", JSON.stringify(rewards));
                }

                generateProblem();


                return { answer, restartGame, backToMenu, score, nbrQuestions, responses, showDialog, problem, progress, selected, correctAnswer };
            }
        });

        const vuetify = createVuetify();
        app.use(vuetify);
        app.mount('#app');
    </script>
    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", async () => {
                try {
                    const reg = await navigator.serviceWorker.register("./service-worker.js", { scope: "/" });
                    // (optionnel) auto-update du SW
                    setInterval(() => reg.update(), 60 * 60 * 1000); // toutes les heures

                    // (optionnel) activer la nouvelle version immédiatement
                    navigator.serviceWorker.addEventListener("controllerchange", () => {
                        // tu peux rafraîchir l’UI ici si besoin
                    });
                } catch (e) {
                    console.error("SW registration failed", e);
                }
            });
        }
    </script>
</body>

</html>